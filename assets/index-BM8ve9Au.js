const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./FontLoader-CZ8w0Gaw.js","./three-PA21n8PD.js"])))=>i.map(i=>d[i]);
import{V as d,aq as G,bp as j,al as z,d as y,$ as f,an as O,bq as W,br as k,bs as q,bt as U,D as V,G as _,aZ as $,b as M,C as Y,r as X,a_ as H}from"./three-PA21n8PD.js";import{c as A,T,a as R,e as N,P as E,b as P,V as C,d as Z,A as K,_ as J,f as u,W as Q,S as ee,g as p,L as te,E as ie,I as g,D as x,M as v,h as se,i as oe}from"./iwsdk-1lGE-Pbh.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const o of s)if(o.type==="childList")for(const a of o.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&i(a)}).observe(document,{childList:!0,subtree:!0});function t(s){const o={};return s.integrity&&(o.integrity=s.integrity),s.referrerPolicy&&(o.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?o.credentials="include":s.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function i(s){if(s.ep)return;s.ep=!0;const o=t(s);fetch(s.href,o)}})();const F={X:"X",Y:"Y",Z:"Z"},b=A("Rotation",{speed:{type:T.Float32,default:.05},axis:{type:T.Enum,enum:F,default:F.Y}});class ne extends R({rotatingEntities:{required:[b]}}){update(e){this.queries.rotatingEntities.entities.forEach(t=>{const i=t.object3D;if(!i||!i.visible)return;const s=t.getValue(b,"speed"),o=t.getValue(b,"axis"),a=e*s;o==="Y"?i.rotateY(a):o==="X"?i.rotateX(a):o==="Z"&&i.rotateZ(a)})}}class ae extends R({welcomePanel:{required:[E,P],where:[N(E,"config","/ui/welcome.json")]}}){init(){this.queries.welcomePanel.subscribe("qualify",e=>{const t=P.data.document[e.index];if(!t)return;const i=t.getElementById("xr-button");i.addEventListener("click",()=>{this.world.visibilityState.value===C.NonImmersive?this.world.launchXR():this.world.exitXR()}),this.world.visibilityState.subscribe(s=>{s===C.NonImmersive?i.setProperties({text:"Enter XR"}):i.setProperties({text:"Exit to Browser"})})})}}const S=A("Robot",{});class re extends R({robot:{required:[S]},robotClicked:{required:[S,Z]}}){init(){this.lookAtTarget=new d,this.vec3=new d,this.queries.robotClicked.subscribe("qualify",e=>{K.play(e)})}update(){this.queries.robot.entities.forEach(e=>{this.player.head.getWorldPosition(this.lookAtTarget);const t=e.object3D;t.getWorldPosition(this.vec3),this.lookAtTarget.y=this.vec3.y,t.lookAt(this.lookAtTarget)})}}function le(n={}){return{dataUrl:n.dataUrl??"https://flowz-iwsdk-dev.onrender.com/data",useMock:n.useMock??!1,updateInterval:n.updateInterval??100,playerRadius:n.playerRadius??1,playerColor:n.playerColor??16711680,debugMode:n.debugMode??!1,boundingBox:n.boundingBox,showBounds:n.showBounds??!1,labelHeight:n.labelHeight??5,labelFontSize:n.labelFontSize??5,labelColor:n.labelColor??65280,trailEnabled:n.trailEnabled??!0,trailLength:n.trailLength??40,trailOpacity:n.trailOpacity??.9,trailWidth:n.trailWidth??.4}}class ce{constructor(){this.matrix=new G().set(.00646297824,-79977569e-12,.000127492645,378432681e-14,487270525e-13,.00630588861,.000169270224,-.00659015663,.000106918946),this.offset=new d(.73352882,68.92531057,8.32454724)}map(e){return e.clone().applyMatrix3(this.matrix).add(this.offset)}}class de{constructor(e,t,i=!1){this.dataUrl=e,this.useMock=t,this.debugMode=i}getMock(){return[{name:"P1",x:1983.85,y:-9436.94,z:2688.65,velocity:{x:50,y:0,z:30}},{name:"P2",x:9215.21,y:9232.86,z:-11263.97,velocity:{x:-20,y:40,z:0}}]}async fetch(){if(this.useMock)return this.getMock();try{const e=await fetch(this.dataUrl,{mode:"cors"});if(!e.ok)throw new Error(`HTTP ${e.status}`);return(await e.json()).players??[]}catch(e){return this.debugMode&&console.error("Data fetch failed",e),[]}}}class he extends j{constructor(e,t={}){const i=t.font;if(i===void 0)super();else{const s=i.generateShapes(e,t.size);t.depth===void 0&&(t.depth=50),t.bevelThickness===void 0&&(t.bevelThickness=10),t.bevelSize===void 0&&(t.bevelSize=8),t.bevelEnabled===void 0&&(t.bevelEnabled=!1),super(s,t)}this.type="TextGeometry"}}class ue{constructor(e,t,i){this.labelFontSize=e,this.labelColor=t,this.labelHeight=i,this.font=null}async loadFont(){try{const{FontLoader:e}=await J(async()=>{const{FontLoader:t}=await import("./FontLoader-CZ8w0Gaw.js");return{FontLoader:t}},__vite__mapDeps([0,1]),import.meta.url);this.font=await new e().loadAsync("https://threejs.org/examples/fonts/helvetiker_regular.typeface.json")}catch(e){console.warn("Font failed → using sprite labels",e),this.font=null}}createLabel(e,t){let i=1;e.parent&&"geometry"in e.parent&&e.parent.geometry instanceof z&&(i=e.parent.geometry.parameters.radius);const s=i-1.8;if(this.font){const o=new he(t,{font:this.font,size:this.labelFontSize,depth:.05});o.computeBoundingBox();const a=o.boundingBox.max.x-o.boundingBox.min.x,r=new y(o,new f({color:this.labelColor}));return r.position.set(-a/2,s,0),e.add(r),r}else{const o=document.createElement("canvas"),a=256;o.width=a,o.height=a;const r=o.getContext("2d");r.fillStyle="rgba(0,0,0,0.7)",r.fillRect(0,0,a,a),r.font=`bold ${this.labelFontSize*18}px Arial`,r.fillStyle=`#${this.labelColor.toString(16).padStart(6,"0")}`,r.textAlign="center",r.textBaseline="middle",r.fillText(t,a/2,a/2);const c=new O(o),h=new W({map:c,transparent:!0,depthTest:!1}),l=new k(h);return l.center.set(.5,0),l.scale.set(this.labelFontSize*3,this.labelFontSize*3,1),l.position.y=s,e.add(l),l}}}class pe{constructor(e,t,i,s,o){this.trailEnabled=e,this.trailLength=t,this.trailWidth=i,this.trailOpacity=s,this.cityMesh=o}updateTrail(e,t){if(!this.trailEnabled||e.points.length<2)return;const i=new q(e.points),s=new U(i,40,this.trailWidth,8,!1),o=new f({color:t,transparent:!0,opacity:this.trailOpacity,side:V});if(e.trail)e.trail.geometry.dispose(),e.trail.geometry=s,e.trail.material.color.copy(t);else{const a=new y(s,o);this.cityMesh.add(a),e.trail=a}}}class me{constructor(e,t,i,s,o,a){this.world=e,this.cityMesh=t,this.configRadius=i,this.baseColor=s,this.labelRenderer=o,this.trailRenderer=a}create(e){const t=new y(new z(this.configRadius),new f({color:this.baseColor})),i=this.world.createTransformEntity(t);if(!i.object3D)throw new Error("Failed");this.cityMesh.add(i.object3D);const s=new _;s.matrixAutoUpdate=!0,this.world.scene.add(s);const o={entity:i,mesh:t,label:void 0,labelRoot:s,points:[]};return o.label=this.labelRenderer.createLabel(s,e),o}updateColor(e,t){e.material.color.copy(t)}updateTrail(e,t){this.trailRenderer.updateTrail(e,t)}}class ye{show(e,t,i){const s=e.getSize(new d),o=e.getCenter(new d),a=new y(new $(s.x,s.y,s.z),new f({color:65280,wireframe:!0}));a.position.copy(o),this.entity=t.createTransformEntity(a),i.add(this.entity.object3D)}destroy(e){this.entity?.object3D&&(e.remove(this.entity.object3D),this.entity.destroy?.())}}class be{constructor(){this.camPos=new d}start(e,t){this.frameId&&cancelAnimationFrame(this.frameId);const i=()=>{e.camera.getWorldPosition(this.camPos),t.forEach(s=>{if(!s.labelRoot||!s.label)return;const o=new d;s.entity.object3D.getWorldPosition(o),o.y+=s.mesh.scale.x,s.labelRoot.position.copy(o),s.labelRoot.lookAt(this.camPos.x,o.y,this.camPos.z),s.label instanceof k&&(s.label.material.rotation=0)}),console.log(`Billboarding running → ${t.size} players`),this.frameId=requestAnimationFrame(i)};i()}stop(){this.frameId&&cancelAnimationFrame(this.frameId)}}class B{constructor(e,t,i={}){if(this.world=e,this.cityMesh=t,this.userConfig=i,this.config=le(this.userConfig),this.transformer=new ce,this.dataFetcher=new de(this.config.dataUrl,this.config.useMock,this.config.debugMode),this.labelRenderer=new ue(this.config.labelFontSize,this.config.labelColor,this.config.labelHeight),this.trailRenderer=new pe(this.config.trailEnabled,this.config.trailLength,this.config.trailWidth,this.config.trailOpacity,this.cityMesh),this.playerEntity=new me(this.world,this.cityMesh,this.config.playerRadius,this.config.playerColor,this.labelRenderer,this.trailRenderer),this.boundsDebugger=new ye,this.billboarding=new be,this.players=new Map,this.lastPos=new Map,this.bounds=this.config.boundingBox?this.config.boundingBox.clone().expandByScalar(2):new M().setFromObject(t),this.config.showBounds&&this.boundsDebugger.show(this.bounds,e,t),this.config.debugMode&&this.bounds){const s=this.bounds.getCenter(new d),o=this.bounds.getSize(new d);console.log(`Bounds – center: [${s.toArray()}] size: [${o.toArray()}]`)}this.labelRenderer.loadFont().then(()=>this.restartAllLabels()),this.startPolling()}async updatePlayers(){const e=await this.dataFetcher.fetch();if(!e.length)return;const t=new Set;for(const i of e){t.add(i.name);const s=typeof i.velocity=="string"?i.velocity.match(/\[([\d.-]+) ([\d.-]+) ([\d.-]+)\]/)?{x:+RegExp.$1,y:+RegExp.$2,z:+RegExp.$3}:{x:0,y:0,z:0}:i.velocity,o=this.transformer.map(new d(i.x,i.y,i.z));if(this.bounds&&!this.bounds.containsPoint(o))continue;const a=Math.hypot(s.x,s.y,s.z),r=new Y().setHSL(a/100%1,1,.5);let c=this.players.get(i.name);c||(c=this.playerEntity.create(i.name),this.players.set(i.name,c),this.players.size===1&&(this.billboarding.start(this.world,this.players),console.log("Billboarding STARTED with",this.players.size,"players"))),c.entity.object3D.position.copy(o),this.playerEntity.updateColor(c.mesh,r);const h=this.lastPos.get(i.name),l=o.clone();h&&c.points.length===0&&c.points.push(h.clone()),c.points.push(l),c.points.length>this.config.trailLength&&c.points.shift(),this.lastPos.set(i.name,l),this.playerEntity.updateTrail(c,r)}for(const[i]of this.players)t.has(i)||this.removePlayer(i)}removePlayer(e){const t=this.players.get(e);if(!t)return;const{entity:i,mesh:s,label:o,trail:a,labelRoot:r}=t;i.object3D&&(this.cityMesh.remove(i.object3D),i.destroy?.()),s.geometry.dispose(),s.material.dispose(),o instanceof y?(o.geometry.dispose(),o.material.dispose()):o&&(o.material.map?.dispose(),o.material.dispose()),a&&(this.cityMesh.remove(a),a.geometry.dispose(),a.material.dispose()),r?.parent&&this.world.scene.remove(r),this.players.delete(e),this.lastPos.delete(e)}restartAllLabels(){this.players.forEach((e,t)=>{e.label?.parent&&e.labelRoot.remove(e.label),e.label=this.labelRenderer.createLabel(e.labelRoot,t)})}startPolling(){this.updatePlayers(),this.timer=window.setInterval(()=>this.updatePlayers(),this.config.updateInterval)}destroy(){this.timer&&clearInterval(this.timer),this.billboarding.stop(),this.players.forEach((e,t)=>this.removePlayer(t)),this.players.clear(),this.lastPos.clear(),this.boundsDebugger.destroy(this.cityMesh)}}const fe={chimeSound:{url:"/audio/chime.mp3",type:u.Audio,priority:"background"},webxr:{url:"/textures/webxr.png",type:u.Texture,priority:"critical"},environmentDesk:{url:"/gltf/environmentDesk/environmentDesk.gltf",type:u.GLTF,priority:"critical"},plantSansevieria:{url:"/gltf/plantSansevieria/plantSansevieria.gltf",type:u.GLTF,priority:"critical"},bigCity:{url:"/gltf/BigCity/BigcityV1.glb",type:u.GLTF,priority:"critical"},summonersRift:{url:"/gltf/SummonersRift/SUMMONERSRIFT.glb",type:u.GLTF,priority:"critical"},robot:{url:"/gltf/robot/robot.gltf",type:u.GLTF,priority:"critical"}},m={bigCity:{meshKey:"bigCity",position:new d(0,.9,-2),scale:.01,boundingBox:new M(new d(-85,-2,-75),new d(85,100,95)).expandByScalar(2)},summonersRift:{meshKey:"summonersRift",position:new d(0,-1.75,-2),scale:.15,boundingBox:new M(new d(-15,17.3,-15),new d(15,19,15)).expandByScalar(2)}};let L="bigCity",w=null;Q.create(document.getElementById("scene-container"),{assets:fe,xr:{sessionMode:ee.ImmersiveVR,offer:"always",features:{handTracking:!0,layers:!0}},features:{locomotion:{useWorker:!0},grabbing:!0,physics:!1,sceneUnderstanding:!1}}).then(n=>{n.registerSystem(ne);const{camera:e}=n;e.position.set(-4,1.5,-6),e.rotateY(-Math.PI*.75);const{scene:t}=p.getGLTF("environmentDesk");t.rotateY(Math.PI),t.position.set(0,-.1,0),n.createTransformEntity(t).addComponent(te,{type:ie.STATIC});const i=p.getGLTF("bigCity").scene,s=p.getGLTF("summonersRift").scene;i.position.copy(m.bigCity.position),i.scale.setScalar(m.bigCity.scale),i.updateMatrixWorld(!0),n.createTransformEntity(i).addComponent(g).addComponent(x,{movementMode:v.MoveFromTarget}).addComponent(b,{speed:.05,axis:"Y"}),s.position.copy(m.summonersRift.position),s.scale.setScalar(m.summonersRift.scale),s.updateMatrixWorld(!0),n.createTransformEntity(s).addComponent(g).addComponent(x,{movementMode:v.MoveFromTarget}).addComponent(b,{speed:.05,axis:"Y"}),s.visible=!1,w=new B(n,i,{useMock:!1,dataUrl:"https://flowz-iwsdk-dev.onrender.com/data",playerRadius:1,debugMode:!0,showBounds:!0,boundingBox:m.bigCity.boundingBox,trailEnabled:!0,trailLength:40,trailWidth:.4,trailOpacity:.9,labelFontSize:.1});const o=()=>{const l=L==="bigCity"?"summonersRift":"bigCity",D=m[l],I=l==="bigCity"?i:s;i.visible=l==="bigCity",s.visible=l==="summonersRift",w?.destroy(),w=new B(n,I,{useMock:!1,dataUrl:"https://flowz-iwsdk-dev.onrender.com/data",playerRadius:1,debugMode:!0,showBounds:!0,boundingBox:D.boundingBox,trailEnabled:!0,trailLength:40,trailWidth:.4,trailOpacity:.9,labelFontSize:.8}),L=l,console.log(`Switched to ${l}`)};window.addEventListener("keydown",l=>{l.key.toLowerCase()==="m"&&o()});const{scene:a}=p.getGLTF("plantSansevieria");a.position.set(1.2,.85,-1.8),n.createTransformEntity(a).addComponent(g).addComponent(x,{movementMode:v.MoveFromTarget});const{scene:r}=p.getGLTF("robot");r.position.set(-1.2,.95,-1.8),r.scale.setScalar(.5),n.createTransformEntity(r).addComponent(g).addComponent(S).addComponent(se,{src:"/audio/chime.mp3",maxInstances:3,playbackMode:oe.FadeRestart});const c=p.getTexture("webxr");c.colorSpace=X;const h=new y(new H(3.39,.96),new f({map:c,transparent:!0}));n.createTransformEntity(h),h.position.set(0,1,1.8),h.rotateY(Math.PI),n.registerSystem(ae).registerSystem(re),window.addEventListener("beforeunload",()=>{w?.destroy()})});
