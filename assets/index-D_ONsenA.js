const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./FontLoader-CZ8w0Gaw.js","./three-PA21n8PD.js"])))=>i.map(i=>d[i]);
import{V as d,aq as G,bp as j,al as z,d as y,$ as f,an as O,bq as W,br as k,bs as q,bt as U,D as V,G as _,aZ as $,b as M,C as Y,r as X,a_ as H}from"./three-PA21n8PD.js";import{c as A,T,a as R,e as N,P as E,b as P,V as C,d as Z,A as K,_ as J,f as u,W as Q,S as ee,g as p,L as te,E as se,I as g,D as x,M as v,h as ie,i as oe}from"./iwsdk-1lGE-Pbh.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const n of o.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&s(n)}).observe(document,{childList:!0,subtree:!0});function t(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(i){if(i.ep)return;i.ep=!0;const o=t(i);fetch(i.href,o)}})();const F={X:"X",Y:"Y",Z:"Z"},b=A("Rotation",{speed:{type:T.Float32,default:.05},axis:{type:T.Enum,enum:F,default:F.Y}});class ae extends R({rotatingEntities:{required:[b]}}){update(e){this.queries.rotatingEntities.entities.forEach(t=>{const s=t.object3D;if(!s||!s.visible)return;const i=t.getValue(b,"speed"),o=t.getValue(b,"axis"),n=e*i;o==="Y"?s.rotateY(n):o==="X"?s.rotateX(n):o==="Z"&&s.rotateZ(n)})}}class ne extends R({welcomePanel:{required:[E,P],where:[N(E,"config","/ui/welcome.json")]}}){init(){this.queries.welcomePanel.subscribe("qualify",e=>{const t=P.data.document[e.index];if(!t)return;const s=t.getElementById("xr-button");s.addEventListener("click",()=>{this.world.visibilityState.value===C.NonImmersive?this.world.launchXR():this.world.exitXR()}),this.world.visibilityState.subscribe(i=>{i===C.NonImmersive?s.setProperties({text:"Enter XR"}):s.setProperties({text:"Exit to Browser"})})})}}const S=A("Robot",{});class re extends R({robot:{required:[S]},robotClicked:{required:[S,Z]}}){init(){this.lookAtTarget=new d,this.vec3=new d,this.queries.robotClicked.subscribe("qualify",e=>{K.play(e)})}update(){this.queries.robot.entities.forEach(e=>{this.player.head.getWorldPosition(this.lookAtTarget);const t=e.object3D;t.getWorldPosition(this.vec3),this.lookAtTarget.y=this.vec3.y,t.lookAt(this.lookAtTarget)})}}function le(a={}){return{dataUrl:a.dataUrl??"https://flowz-iwsdk-dev.onrender.com/data",useMock:a.useMock??!1,updateInterval:a.updateInterval??100,playerRadius:a.playerRadius??1,playerColor:a.playerColor??16711680,debugMode:a.debugMode??!1,boundingBox:a.boundingBox,showBounds:a.showBounds??!1,labelHeight:a.labelHeight??5,labelFontSize:a.labelFontSize??5,labelColor:a.labelColor??65280,trailEnabled:a.trailEnabled??!0,trailLength:a.trailLength??40,trailOpacity:a.trailOpacity??.9,trailWidth:a.trailWidth??.4}}class ce{constructor(){this.matrix=new G().set(.00646297824,-79977569e-12,.000127492645,378432681e-14,487270525e-13,.00630588861,.000169270224,-.00659015663,.000106918946),this.offset=new d(.73352882,68.92531057,8.32454724)}map(e){return e.clone().applyMatrix3(this.matrix).add(this.offset)}}class de{constructor(e,t,s=!1){this.dataUrl=e,this.useMock=t,this.debugMode=s}getMock(){return[{name:"P1",x:1983.85,y:-9436.94,z:2688.65,velocity:{x:50,y:0,z:30}},{name:"P2",x:9215.21,y:9232.86,z:-11263.97,velocity:{x:-20,y:40,z:0}}]}async fetch(){if(this.useMock)return this.getMock();try{const e=await fetch(this.dataUrl,{mode:"cors"});if(!e.ok)throw new Error(`HTTP ${e.status}`);return(await e.json()).players??[]}catch(e){return this.debugMode&&console.error("Data fetch failed",e),[]}}}class he extends j{constructor(e,t={}){const s=t.font;if(s===void 0)super();else{const i=s.generateShapes(e,t.size);t.depth===void 0&&(t.depth=50),t.bevelThickness===void 0&&(t.bevelThickness=10),t.bevelSize===void 0&&(t.bevelSize=8),t.bevelEnabled===void 0&&(t.bevelEnabled=!1),super(i,t)}this.type="TextGeometry"}}class ue{constructor(e,t,s){this.labelFontSize=e,this.labelColor=t,this.labelHeight=s,this.font=null}async loadFont(){try{const{FontLoader:e}=await J(async()=>{const{FontLoader:t}=await import("./FontLoader-CZ8w0Gaw.js");return{FontLoader:t}},__vite__mapDeps([0,1]),import.meta.url);this.font=await new e().loadAsync("https://threejs.org/examples/fonts/helvetiker_regular.typeface.json")}catch(e){console.warn("Font failed → using sprite labels",e),this.font=null}}createLabel(e,t){let s=1;e.parent&&"geometry"in e.parent&&e.parent.geometry instanceof z&&(s=e.parent.geometry.parameters.radius);const i=s-1.8;if(this.font){const o=new he(t,{font:this.font,size:this.labelFontSize,depth:.05});o.computeBoundingBox();const n=o.boundingBox.max.x-o.boundingBox.min.x,r=new y(o,new f({color:this.labelColor}));return r.position.set(-n/2,i,0),e.add(r),r}else{const o=document.createElement("canvas"),n=256;o.width=n,o.height=n;const r=o.getContext("2d");r.fillStyle="rgba(0,0,0,0.7)",r.fillRect(0,0,n,n),r.font=`bold ${this.labelFontSize*18}px Arial`,r.fillStyle=`#${this.labelColor.toString(16).padStart(6,"0")}`,r.textAlign="center",r.textBaseline="middle",r.fillText(t,n/2,n/2);const c=new O(o),h=new W({map:c,transparent:!0,depthTest:!1}),l=new k(h);return l.center.set(.5,0),l.scale.set(this.labelFontSize*3,this.labelFontSize*3,1),l.position.y=i,e.add(l),l}}}class pe{constructor(e,t,s,i,o){this.trailEnabled=e,this.trailLength=t,this.trailWidth=s,this.trailOpacity=i,this.cityMesh=o}updateTrail(e,t){if(!this.trailEnabled||e.points.length<2)return;const s=new q(e.points),i=new U(s,40,this.trailWidth,8,!1),o=new f({color:t,transparent:!0,opacity:this.trailOpacity,side:V});if(e.trail)e.trail.geometry.dispose(),e.trail.geometry=i,e.trail.material.color.copy(t);else{const n=new y(i,o);this.cityMesh.add(n),e.trail=n}}}class me{constructor(e,t,s,i,o,n){this.world=e,this.cityMesh=t,this.configRadius=s,this.baseColor=i,this.labelRenderer=o,this.trailRenderer=n}create(e){const t=new y(new z(this.configRadius),new f({color:this.baseColor})),s=this.world.createTransformEntity(t);if(!s.object3D)throw new Error("Failed");this.cityMesh.add(s.object3D);const i=new _;i.matrixAutoUpdate=!0,this.world.scene.add(i);const o={entity:s,mesh:t,label:void 0,labelRoot:i,points:[]};return o.label=this.labelRenderer.createLabel(i,e),o}updateColor(e,t){e.material.color.copy(t)}updateTrail(e,t){this.trailRenderer.updateTrail(e,t)}}class ye{show(e,t,s){const i=e.getSize(new d),o=e.getCenter(new d),n=new y(new $(i.x,i.y,i.z),new f({color:65280,wireframe:!0}));n.position.copy(o),this.entity=t.createTransformEntity(n),s.add(this.entity.object3D)}destroy(e){this.entity?.object3D&&(e.remove(this.entity.object3D),this.entity.destroy?.())}}class be{constructor(){this.camPos=new d}start(e,t){this.frameId&&cancelAnimationFrame(this.frameId);const s=()=>{e.camera.getWorldPosition(this.camPos),t.forEach(i=>{if(!i.labelRoot||!i.label)return;const o=new d;i.entity.object3D.getWorldPosition(o),o.y+=i.mesh.scale.x,i.labelRoot.position.copy(o),i.labelRoot.lookAt(this.camPos.x,o.y,this.camPos.z),i.label instanceof k&&(i.label.material.rotation=0)}),console.log(`Billboarding running → ${t.size} players`),this.frameId=requestAnimationFrame(s)};s()}stop(){this.frameId&&cancelAnimationFrame(this.frameId)}}class B{constructor(e,t,s={}){if(this.world=e,this.cityMesh=t,this.userConfig=s,this.config=le(this.userConfig),this.transformer=new ce,this.dataFetcher=new de(this.config.dataUrl,this.config.useMock,this.config.debugMode),this.labelRenderer=new ue(this.config.labelFontSize,this.config.labelColor,this.config.labelHeight),this.trailRenderer=new pe(this.config.trailEnabled,this.config.trailLength,this.config.trailWidth,this.config.trailOpacity,this.cityMesh),this.playerEntity=new me(this.world,this.cityMesh,this.config.playerRadius,this.config.playerColor,this.labelRenderer,this.trailRenderer),this.boundsDebugger=new ye,this.billboarding=new be,this.players=new Map,this.lastPos=new Map,this.bounds=this.config.boundingBox?this.config.boundingBox.clone().expandByScalar(2):new M().setFromObject(t),this.config.showBounds&&this.boundsDebugger.show(this.bounds,e,t),this.config.debugMode&&this.bounds){const i=this.bounds.getCenter(new d),o=this.bounds.getSize(new d);console.log(`Bounds – center: [${i.toArray()}] size: [${o.toArray()}]`)}this.labelRenderer.loadFont().then(()=>this.restartAllLabels()),this.startPolling()}async updatePlayers(){const e=await this.dataFetcher.fetch();if(!e.length)return;const t=new Set;for(const s of e){t.add(s.name);const i=typeof s.velocity=="string"?s.velocity.match(/\[([\d.-]+) ([\d.-]+) ([\d.-]+)\]/)?{x:+RegExp.$1,y:+RegExp.$2,z:+RegExp.$3}:{x:0,y:0,z:0}:s.velocity,o=this.transformer.map(new d(s.x,s.y,s.z));if(this.bounds&&!this.bounds.containsPoint(o))continue;const n=Math.hypot(i.x,i.y,i.z),r=new Y().setHSL(n/100%1,1,.5);let c=this.players.get(s.name);c||(c=this.playerEntity.create(s.name),this.players.set(s.name,c),this.players.size===1&&(this.billboarding.start(this.world,this.players),console.log("Billboarding STARTED with",this.players.size,"players"))),c.entity.object3D.position.copy(o),this.playerEntity.updateColor(c.mesh,r);const h=this.lastPos.get(s.name),l=o.clone();h&&c.points.length===0&&c.points.push(h.clone()),c.points.push(l),c.points.length>this.config.trailLength&&c.points.shift(),this.lastPos.set(s.name,l),this.playerEntity.updateTrail(c,r)}for(const[s]of this.players)t.has(s)||this.removePlayer(s)}removePlayer(e){const t=this.players.get(e);if(!t)return;const{entity:s,mesh:i,label:o,trail:n,labelRoot:r}=t;s.object3D&&(this.cityMesh.remove(s.object3D),s.destroy?.()),i.geometry.dispose(),i.material.dispose(),o instanceof y?(o.geometry.dispose(),o.material.dispose()):o&&(o.material.map?.dispose(),o.material.dispose()),n&&(this.cityMesh.remove(n),n.geometry.dispose(),n.material.dispose()),r?.parent&&this.world.scene.remove(r),this.players.delete(e),this.lastPos.delete(e)}restartAllLabels(){this.players.forEach((e,t)=>{e.label?.parent&&e.labelRoot.remove(e.label),e.label=this.labelRenderer.createLabel(e.labelRoot,t)})}startPolling(){this.updatePlayers(),this.timer=window.setInterval(()=>this.updatePlayers(),this.config.updateInterval)}destroy(){this.timer&&clearInterval(this.timer),this.billboarding.stop(),this.players.forEach((e,t)=>this.removePlayer(t)),this.players.clear(),this.lastPos.clear(),this.boundsDebugger.destroy(this.cityMesh)}}const fe={chimeSound:{url:"assets/audio/chime.mp3",type:u.Audio,priority:"background"},webxr:{url:"assets/textures/webxr.png",type:u.Texture,priority:"critical"},environmentDesk:{url:"assets/gltf/environmentDesk/environmentDesk.gltf",type:u.GLTF,priority:"critical"},plantSansevieria:{url:"assets/gltf/plantSansevieria/plantSansevieria.gltf",type:u.GLTF,priority:"critical"},bigCity:{url:"assets/gltf/BigCity/BigcityV1.glb",type:u.GLTF,priority:"critical"},summonersRift:{url:"assets/gltf/SummonersRift/SUMMONERSRIFT.glb",type:u.GLTF,priority:"critical"},robot:{url:"assets/gltf/robot/robot.gltf",type:u.GLTF,priority:"critical"}},m={bigCity:{meshKey:"bigCity",position:new d(0,.9,-2),scale:.01,boundingBox:new M(new d(-85,-2,-75),new d(85,100,95)).expandByScalar(2)},summonersRift:{meshKey:"summonersRift",position:new d(0,-1.75,-2),scale:.15,boundingBox:new M(new d(-15,17.3,-15),new d(15,19,15)).expandByScalar(2)}};let L="bigCity",w=null;Q.create(document.getElementById("scene-container"),{assets:fe,xr:{sessionMode:ee.ImmersiveVR,offer:"always",features:{handTracking:!0,layers:!0}},features:{locomotion:{useWorker:!0},grabbing:!0,physics:!1,sceneUnderstanding:!1}}).then(a=>{a.registerSystem(ae);const{camera:e}=a;e.position.set(-4,1.5,-6),e.rotateY(-Math.PI*.75);const{scene:t}=p.getGLTF("environmentDesk");t.rotateY(Math.PI),t.position.set(0,-.1,0),a.createTransformEntity(t).addComponent(te,{type:se.STATIC});const s=p.getGLTF("bigCity").scene,i=p.getGLTF("summonersRift").scene;s.position.copy(m.bigCity.position),s.scale.setScalar(m.bigCity.scale),s.updateMatrixWorld(!0),a.createTransformEntity(s).addComponent(g).addComponent(x,{movementMode:v.MoveFromTarget}).addComponent(b,{speed:.05,axis:"Y"}),i.position.copy(m.summonersRift.position),i.scale.setScalar(m.summonersRift.scale),i.updateMatrixWorld(!0),a.createTransformEntity(i).addComponent(g).addComponent(x,{movementMode:v.MoveFromTarget}).addComponent(b,{speed:.05,axis:"Y"}),i.visible=!1,w=new B(a,s,{useMock:!1,dataUrl:"https://flowz-iwsdk-dev.onrender.com/data",playerRadius:1,debugMode:!0,showBounds:!0,boundingBox:m.bigCity.boundingBox,trailEnabled:!0,trailLength:40,trailWidth:.4,trailOpacity:.9,labelFontSize:.1});const o=()=>{const l=L==="bigCity"?"summonersRift":"bigCity",D=m[l],I=l==="bigCity"?s:i;s.visible=l==="bigCity",i.visible=l==="summonersRift",w?.destroy(),w=new B(a,I,{useMock:!1,dataUrl:"https://flowz-iwsdk-dev.onrender.com/data",playerRadius:1,debugMode:!0,showBounds:!0,boundingBox:D.boundingBox,trailEnabled:!0,trailLength:40,trailWidth:.4,trailOpacity:.9,labelFontSize:.8}),L=l,console.log(`Switched to ${l}`)};window.addEventListener("keydown",l=>{l.key.toLowerCase()==="m"&&o()});const{scene:n}=p.getGLTF("plantSansevieria");n.position.set(1.2,.85,-1.8),a.createTransformEntity(n).addComponent(g).addComponent(x,{movementMode:v.MoveFromTarget});const{scene:r}=p.getGLTF("robot");r.position.set(-1.2,.95,-1.8),r.scale.setScalar(.5),a.createTransformEntity(r).addComponent(g).addComponent(S).addComponent(ie,{src:"/audio/chime.mp3",maxInstances:3,playbackMode:oe.FadeRestart});const c=p.getTexture("webxr");c.colorSpace=X;const h=new y(new H(3.39,.96),new f({map:c,transparent:!0}));a.createTransformEntity(h),h.position.set(0,1,1.8),h.rotateY(Math.PI),a.registerSystem(ne).registerSystem(re),window.addEventListener("beforeunload",()=>{w?.destroy()})});
